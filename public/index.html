<!doctype html>
<html>

    <head>

        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.dev.js"></script>


    </head>

    <style type="text/css">

        #container {
            height: 95vh;
        }

    </style>

    <body>

            <div id="container"></div>

            <script type="text/javascript">

                $.getJSON(

                    '/json',

                    function (data) {

                        // data = [];

                        Highcharts.setOptions({
                            time: {
                                timezoneOffset: -3 * 60
                            }
                        });

                        const chart = Highcharts.chart('container', {

                            credits: {
                                enabled: false
                            },

                            chart: {
                                zoomType: 'x'
                            },
                            title: {
                                text: 'co2 ppm for last hour'
                            },
                            xAxis: {
                                type: 'datetime'
                            },
                            yAxis: {
                                min: 350,
                                max: 2500,
                                title: null
                            },
                            legend: {
                                enabled: false
                            },
                            plotOptions: {
                                area: {
                                    fillColor: {
                                        linearGradient: {
                                            x1: 0,
                                            y1: 0,
                                            x2: 0,
                                            y2: 1
                                        },
                                        stops: [
                                            [0, Highcharts.getOptions().colors[0]],
                                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                        ]
                                    },
                                    marker: {
                                        radius: 2
                                    },
                                    lineWidth: 1,
                                    states: {
                                        hover: {
                                            lineWidth: 1
                                        }
                                    },
                                    threshold: null
                                }
                            },

                            series: [{
                                type: 'area',
                                name: 'co2 ppm',
                                data,
                            }]

                        });

                        const socket = io('http://localhost:8888');
                        socket.on('ppm', function(point) {
                            const { timestamp, ppm } = point;

                            const series = chart.series[0];

                            const { points } = series;

                            const size = points.length
                                ? points[points.length - 1].x - points[0].x
                                : null;

                            const shift = size > 60 * 60 * 1000;

                            series.addPoint(
                                [ timestamp, ppm ],
                                true,
                                shift,
                            );
                            console.log('ws received point: ', point);
                        });

                    }
                );
            </script>

    </body>
</html>

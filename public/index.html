<!doctype html>
<html>

    <head>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.dev.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>
    </head>

    <style type="text/css">

        #container {
            height: calc(100vh - 48px);
        }

        #ppm,
        #temp {
            position: fixed;
            right: 0;
            font-size: 36px;
            margin: 15px;
            color: #777;
            /* background: #DCEDC8;
            border-radius: 5px;
            padding: 5px; */
        }

        .controls {
            display: flex;
        }
        .controls,
        .controls > select
        {
            font-size: 24px;
            color: #777;
        }

        #ppm {
            top: 0
        }
        #temp {
            right: 34px;
            top: 36px
        }

        #temp:after {
            content: ' Â°C';
        }

        #ppm:after {
            content: ' PPM';
        }

        .highcharts-area.zone-good {
            fill: #DCEDC8;
            opacity: .5;
        }
        .highcharts-area.zone-warn {
            fill: #FFECB3;
            opacity: .5;
        }
        .highcharts-area.zone-bad {
            fill: #FFAB91;
            opacity: .5;
        }

    </style>

    <body>

            <div class="controls">
                historical data for past&nbsp;
                <select id="windowSize">
                    <option value="600">10 minutes</option>
                    <option value="1800">30 minutes</option>
                    <option value="3600" selected>1 hour</option>
                    <option value="10800">3 hours</option>
                    <option value="43200">12 hours</option>
                    <option value="86400">1 day</option>
                    <option value="604800">7 days</option>
                </select>
            </div>

            <div id="container"></div>

            <div id="ppm">&mdash;</div>
            <div id="temp">&mdash;</div>

            <script type="text/javascript">

                let $ppm;
                let $temp;
                let constants;
                let chart;

                document.addEventListener('DOMContentLoaded', async function() {

                    $ppm = document.getElementById('ppm');
                    $temp = document.getElementById('temp');

                    // load settings
                    const rsp = await fetch('/constants');
                    constants = await rsp.json();

                    // init chart
                    chart = initChart();

                    const wsSelect = document.getElementById('windowSize');
                    wsSelect.addEventListener('change', () => {
                        fetchAndUpdate(chart, wsSelect.value);
                    });

                    // fetch points
                    await fetchAndUpdate(chart, wsSelect.value);

                    listenWS(chart);

                });

                function listenWS() {
                    const socket = io(`http://${constants.APP_HOST}:${constants.APP_PORT}`);
                    socket.on(constants.MESSAGE_NAME, (point) => {
                        const { timestamp, ppm, temperature } = point;
                        const series = chart.series[0];
                        const { points } = series;
                        series.addPoint(
                            [ timestamp, ppm ],
                            true,
                            false,
                        );
                        $ppm.textContent = ppm;
                        $temp.textContent = temperature;
                        console.log('ws received point: ', point);
                        // const xSize = points.length
                        //     ? points[points.length - 1].x - points[0].x
                        //     : null;
                        // const needShift = xSize > WINDOW_SECONDS * 1000;
                        // needShift,
                    });
                }

                async function fetchAndUpdate(chart, windowSize) {
                    const points = await fetchPoints({ windowSize });
                    chart.series[0].update({ data: points });
                }

                async function fetchPoints({ windowSize }) {
                    const rsp = await fetch(`/json?windowSize=${windowSize}`);
                    return rsp.json();
                }

                function initChart() {
                    Highcharts.setOptions({
                        time: {
                            timezoneOffset: -3 * 60
                        }
                    });
                    return Highcharts.chart('container', {

                        credits: {
                            enabled: false
                        },

                        chart: {
                            zoomType: 'x'
                        },
                        title: {
                            text: null,
                            // text: `co2 ppm for last ${moment().subtract(WINDOW_SECONDS, 'seconds').toNow(true)}`
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: {
                            // min: 350,
                            // max: 2000,
                            title: null
                        },
                        legend: {
                            enabled: false
                        },
                        plotOptions: {
                            area: {
                                // fillColor: {
                                //     linearGradient: {
                                //         x1: 0,
                                //         y1: 0,
                                //         x2: 0,
                                //         y2: 1
                                //     },
                                //     stops: [
                                //         [0, Highcharts.getOptions().colors[0]],
                                //         [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                //     ]
                                // },
                                marker: {
                                    radius: 2
                                },
                                lineWidth: 1,
                                states: {
                                    hover: {
                                        lineWidth: 1
                                    }
                                },
                                threshold: null,
                            },
                            series: {
                                zones: [{
                                    value: 700,
                                    className: 'zone-good'
                                }, {
                                    value: 1300,
                                    className: 'zone-warn'
                                }, {
                                    className: 'zone-bad'
                                }],
                                // threshold: -10
                            }
                        },

                        series: [{
                            type: 'area',
                            name: 'co2 ppm',
                            // data,
                        }]

                    });
                }

            </script>

    </body>
</html>

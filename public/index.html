<!doctype html>
<html>

    <head>

        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.dev.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>

        <!-- <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script> -->

    </head>

    <style type="text/css">

        #container {
            height: 95vh;
        }

        .highcharts-area.zone-good {
            fill: #DCEDC8;
            opacity: .5;
        }
        .highcharts-area.zone-warn {
            fill: #FFECB3;
            opacity: .5;
        }
        .highcharts-area.zone-bad {
            fill: #FFAB91;
            opacity: .5;
        }

        /* @import 'https://code.highcharts.com/css/highcharts.css'; */

        /* .highcharts-point {
            stroke: white;
        } */

        /* .highcharts-graph.zone-0 {
            stroke: #f7a35c;
        } */

        /* .highcharts-point.zone-0 {
            fill: #f7a35c;
        } */

        /* .highcharts-graph.zone-1 {
            stroke: #7cb5ec;
        } */

        /* .highcharts-point.zone-1 {
            fill: #7cb5ec;
        } */
        /* .highcharts-graph.zone-2 {
            stroke: #90ed7d;
        } */
        /* .highcharts-point.zone-2 {
            fill: #90ed7d;
        } */

    </style>

    <body>

            window size, past <select id="windowSize">
                <option value="600">10 minutes</option>
                <option value="1800">30 minutes</option>
                <option value="3600" selected>1 hour</option>
                <option value="10800">3 hours</option>
                <option value="43200">12 hours</option>
                <option value="86400">1 day</option>
                <option value="604800">7 days</option>
            </select>

            <div id="container"></div>

            <script type="text/javascript">

                document.addEventListener('DOMContentLoaded', async function() {

                    // load settings
                    const rsp = await fetch('/constants');
                    const constants = await rsp.json();
                    const {
                        APP_PORT,
                        APP_HOST,
                        STORAGE_FILENAME,
                        PUBLIC_PATH,
                        IPC_ID_HTTP_SERVER,
                        // WINDOW_SECONDS,
                    } = constants;

                    // init chart
                    const chart = initChart();


                    const wsSelect = document.getElementById('windowSize');
                    wsSelect.addEventListener('change', () => {
                        fetchAndUpdate(chart, wsSelect.value);
                    });

                    // fetch points
                    await fetchAndUpdate(chart, wsSelect.value);

                    listenWS(chart, APP_HOST, APP_PORT/*, WINDOW_SECONDS*/);

                });

                function listenWS(chart, host, port/*, WINDOW_SECONDS*/) {
                    const socket = io(`http://${host}:${port}`);
                    socket.on('ppm', (point) => {
                        const { timestamp, ppm } = point;
                        const series = chart.series[0];
                        const { points } = series;
                        const xSize = points.length
                            ? points[points.length - 1].x - points[0].x
                            : null;
                        // const needShift = xSize > WINDOW_SECONDS * 1000;
                        series.addPoint(
                            [ timestamp, ppm ],
                            true,
                            false,
                            // needShift,
                        );
                        console.log('ws received point: ', point);
                    });
                }

                async function fetchAndUpdate(chart, windowSize) {
                    const points = await fetchPoints({ windowSize });
                    chart.series[0].update({ data: points });
                }

                async function fetchPoints({ windowSize }) {
                    const rsp = await fetch(`/json?windowSize=${windowSize}`);
                    return rsp.json();
                }

                function initChart() {
                    Highcharts.setOptions({
                        time: {
                            timezoneOffset: -3 * 60
                        }
                    });
                    return Highcharts.chart('container', {

                        credits: {
                            enabled: false
                        },

                        chart: {
                            zoomType: 'x'
                        },
                        title: {
                            text: null,
                            // text: `co2 ppm for last ${moment().subtract(WINDOW_SECONDS, 'seconds').toNow(true)}`
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: {
                            // min: 350,
                            // max: 2000,
                            title: null
                        },
                        legend: {
                            enabled: false
                        },
                        plotOptions: {
                            area: {
                                // fillColor: {
                                //     linearGradient: {
                                //         x1: 0,
                                //         y1: 0,
                                //         x2: 0,
                                //         y2: 1
                                //     },
                                //     stops: [
                                //         [0, Highcharts.getOptions().colors[0]],
                                //         [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                //     ]
                                // },
                                marker: {
                                    radius: 2
                                },
                                lineWidth: 1,
                                states: {
                                    hover: {
                                        lineWidth: 1
                                    }
                                },
                                threshold: null,
                            },
                            series: {
                                zones: [{
                                    value: 700,
                                    className: 'zone-good'
                                }, {
                                    value: 1300,
                                    className: 'zone-warn'
                                }, {
                                    className: 'zone-bad'
                                }],
                                // threshold: -10
                            }
                        },

                        series: [{
                            type: 'area',
                            name: 'co2 ppm',
                            // data,
                        }]

                    });
                }

            </script>

    </body>
</html>
